Perfect ðŸ‘ â€” since youâ€™re on **RHEL 8**, **Kubernetes v1.28.14**, using **containerd**, and already have the Falco & Falco driver-loader Docker images (`0.41.3`), Iâ€™ll give you a **fully offline-compatible, eBPF-based Falco DaemonSet YAML** that:

âœ… Uses your **local Falco images**
âœ… Works with **containerd**
âœ… Mounts **ConfigMap for falco.yaml & falco_rules.yaml**
âœ… Runs as a **DaemonSet on all nodes**
âœ… Uses **modern_ebpf driver** (no kernel modules or compilation)

---

### ðŸ§© Step 1 â€” Create the Falco configuration files

#### **falco.yaml**

```yaml
# falco.yaml
rules_file:
  - /etc/falco/falco_rules.yaml

json_output: true
json_include_output_property: true
buffered_outputs: false
time_format_iso_8601: true

syscall_event_drops:
  threshold: 0.1
  actions:
    - log
    - alert

http_output:
  enabled: false

webserver:
  enabled: true
  listen_port: 8765

program_output:
  enabled: true
  keep_alive: false
  program: "cat"
```

#### **falco_rules.yaml**

```yaml
# falco_rules.yaml
# Basic container runtime security detections

- rule: Shell in Container
  desc: Detect interactive shells running inside containers
  condition: container and shell_procs and not run_by_falco
  output: >
    Detected shell in container (user=%user.name container=%container.id command=%proc.cmdline)
  priority: WARNING
  tags: [container, shell]

- rule: Write below binary dir
  desc: Detect any write to /bin or /usr/bin inside a container
  condition: >
    container and evt.type in (open,creat,openat) and
    fd.name startswith /bin/ or fd.name startswith /usr/bin/
  output: >
    File below binary dir opened for writing (user=%user.name
    command=%proc.cmdline file=%fd.name)
  priority: ERROR
  tags: [filesystem, container]

- rule: Outbound Connection to Restricted IP
  desc: Detect connections from containers to restricted IP ranges
  condition: >
    container and evt.type=connect and fd.sip in (10.0.0.0/8)
  output: >
    Outbound connection to restricted IP (user=%user.name
    command=%proc.cmdline sip=%fd.sip)
  priority: WARNING
  tags: [network, container]
```

---

### ðŸ§© Step 2 â€” Create ConfigMap in Kubernetes

```bash
kubectl -n falco delete configmap falco-config --ignore-not-found
kubectl -n falco create configmap falco-config \
  --from-file=falco.yaml=./falco.yaml \
  --from-file=falco_rules.yaml=./falco_rules.yaml
```

---

### ðŸ§© Step 3 â€” Apply Falco DaemonSet YAML

Save this as `falco-daemonset-ebpf.yaml`:

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
  namespace: falco
  labels:
    app: falco
spec:
  selector:
    matchLabels:
      app: falco
  template:
    metadata:
      labels:
        app: falco
    spec:
      serviceAccountName: falco
      hostPID: true
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: falco
          image: <your_local_registry>/falco:0.41.3
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          env:
            - name: FALCO_BPF_PROBE
              value: "/root/.falco/falco-bpf.o"
          volumeMounts:
            - name: falco-config
              mountPath: /etc/falco
            - name: dev-fs
              mountPath: /host/dev
            - name: proc-fs
              mountPath: /host/proc
              readOnly: true
            - name: boot-fs
              mountPath: /host/boot
              readOnly: true
            - name: lib-modules
              mountPath: /host/lib/modules
              readOnly: true
            - name: usr
              mountPath: /host/usr
              readOnly: true
        - name: falco-driver-loader
          image: <your_local_registry>/falco-driver-loader:0.41.3
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
          env:
            - name: FALCO_BPF_PROBE
              value: "/root/.falco/falco-bpf.o"
          volumeMounts:
            - name: lib-modules
              mountPath: /host/lib/modules
              readOnly: true
            - name: usr
              mountPath: /host/usr
              readOnly: true
            - name: boot-fs
              mountPath: /host/boot
              readOnly: true
            - name: var-falco
              mountPath: /root/.falco
            - name: etc-falco
              mountPath: /etc/falco
      volumes:
        - name: falco-config
          configMap:
            name: falco-config
        - name: dev-fs
          hostPath:
            path: /dev
        - name: proc-fs
          hostPath:
            path: /proc
        - name: boot-fs
          hostPath:
            path: /boot
        - name: lib-modules
          hostPath:
            path: /lib/modules
        - name: usr
          hostPath:
            path: /usr
        - name: var-falco
          hostPath:
            path: /var/falco
        - name: etc-falco
          hostPath:
            path: /etc/falco
```

> ðŸ”§ Replace `<your_local_registry>` with your local or offline image path (for example, `harbor.equitas.local/security/falco`).

---

### ðŸ§© Step 4 â€” Deploy

```bash
kubectl create ns falco
kubectl -n falco apply -f falco-daemonset-ebpf.yaml
```

Then check:

```bash
kubectl -n falco get pods -o wide
kubectl -n falco logs -l app=falco -c falco --tail=50
```

You should see:

```
Falco initialized with driver type modern_ebpf
Loading rules from /etc/falco/falco_rules.yaml
Starting event loop
```

---

### ðŸ§© Step 5 â€” Test detection

Run this test:

```bash
kubectl run test-shell --image=alpine --restart=Never -it -- sh
```

Inside:

```bash
ls /bin
```

Then check Falco logs:

```bash
kubectl -n falco logs -l app=falco -c falco | grep Shell
```

Expected:

```
Detected shell in container (user=root container=... command=sh)
```

---

Would you like me to include an optional **Falco service + web dashboard (port 8765)** so you can view alerts in a browser?
