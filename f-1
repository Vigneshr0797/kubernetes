sudo mkdir -p /opt/trivy/bin
cd /opt/trivy/bin

curl -LO https://github.com/aquasecurity/trivy/releases/download/v0.55.0/trivy_0.55.0_Linux-64bit.tar.gz
tar -xzf trivy_0.55.0_Linux-64bit.tar.gz
sudo mv trivy /usr/local/bin/trivy
sudo chmod +x /usr/local/bin/trivy

trivy --version
âœ… You now have the official binary, no Docker image.

ðŸ§° 2. Create a Shared Configuration (Optional)


If you want all nodes to use a common config (e.g., DB path, cache, etc.):

sudo mkdir -p /opt/trivy/data
sudo tee /etc/trivy.yaml <<'EOF'
cacheDir: /opt/trivy/data
vulnType:
  - os
  - library
ignoreUnfixed: true
EOF
ðŸ“¦ 3. Create a SystemD Service for Continuous Runtime Scanning


Each node can continuously scan all containers running on it using crictl.



Create the service file:

sudo tee /etc/systemd/system/trivy-runtime.service <<'EOF'
[Unit]
Description=Trivy Runtime Scanner
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/trivy fs --skip-db-update --format json --output /opt/trivy/scan-results.json /
Restart=on-failure
RestartSec=3600

[Install]
WantedBy=multi-user.target
EOF
Then enable and start:

sudo systemctl daemon-reload
sudo systemctl enable trivy-runtime
sudo systemctl start trivy-runtime
This will scan the nodeâ€™s filesystem periodically and output a JSON report at /opt/trivy/scan-results.json.

ðŸ” 4. For Container Runtime (Containerd/CRI-O)


You can directly scan active containers by enumerating them via crictl:



Create a CronJob script at /usr/local/bin/trivy-scan-cri.sh:

#!/bin/bash
SCAN_DIR="/opt/trivy/scans"
mkdir -p $SCAN_DIR
date=$(date +%F_%T)

for id in $(crictl ps -q); do
  name=$(crictl inspect $id | grep name | head -1 | awk -F'"' '{print $4}')
  echo "Scanning container: $name ($id)"
  trivy fs --skip-db-update --format json --output "$SCAN_DIR/$name-$date.json" /run/containerd/io.containerd.runtime.v2.task/k8s.io/$id/rootfs
done
Make it executable:

sudo chmod +x /usr/local/bin/trivy-scan-cri.sh
Create a CronJob via system cron:

sudo crontab -e
Add:

0 */6 * * * /usr/local/bin/trivy-scan-cri.sh
This runs every 6 hours, scanning all running containers and storing results under /opt/trivy/scans.

ðŸ§¾ 5. (Optional) Push Reports into Kubernetes for Visibility


If you want reports visible in Kubernetes:

kubectl create namespace trivy-reports
Create this script /usr/local/bin/trivy-upload-k8s.sh:

#!/bin/bash
SCAN_DIR="/opt/trivy/scans"
for file in $SCAN_DIR/*.json; do
  name=$(basename $file .json)
  kubectl create configmap $name --from-file=$file -n trivy-reports --dry-run=client -o yaml | kubectl apply -f -
done
Schedule it with cron:

15 */6 * * * /usr/local/bin/trivy-upload-k8s.sh
You can then view results in Kubernetes:

kubectl get configmaps -n trivy-reports
kubectl get cm nginx-pod-2025-10-26 -n trivy-reports -o yaml
